
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Itsuki Utaãƒ¼LINE</title>
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", sans-serif;
      background: #e5ddd5;
      color: #000;
    }
    header {
      background: #00c300;
      color: white;
      padding: 1em;
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
    }
    #search {
      width: 90%;
      margin: 1em auto;
      display: block;
      padding: 0.5em;
      font-size: 1em;
      border-radius: 6px;
      border: none;
      background: #f0f0f0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 1em;
    }
    .section {
      background: #fff;
      border-radius: 12px;
      padding: 1em;
      margin-bottom: 1em;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    button {
      background: #00b900;
      color: white;
      border: none;
      padding: 0.4em 1em;
      margin: 0.2em;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #009a00;
    }
    iframe {
      width: 100%;
      height: 200px;
      border: none;
      margin-top: 0.5em;
      border-radius: 6px;
    }
    /* LINEé¢¨ãµãã ã— */
    .bubble {
      max-width: 70%;
      padding: 0.8em 1em;
      border-radius: 16px;
      margin: 0.4em 0;
      word-break: break-word;
      font-size: 0.95em;
    }
    .bubble.left {
      background: white;
      color: #000;
      margin-right: auto;
    }
    .bubble.right {
      background: #dcf8c6;
      color: #000;
      margin-left: auto;
    }
    .bubble span {
      display: block;
      font-weight: bold;
      margin-bottom: 0.3em;
      color: #333;
    }
  </style>
</head>
<body>
  <header><span style="color:#fff">ITSUKI UTA</span><span style="color:#b9ffd1">ãƒ¼LINE</span></header>
  <input id="search" placeholder="æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã§æ¤œç´¢" oninput="render()">
  <div class="container">
    <div class="section">
      <button onclick="toggleRequestLock()" id="lockBtn">ğŸ”“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ï¼šON</button>
      <button onclick="randomRequest()">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
    </div>
    <div class="section">
      <h3>ğŸ“ˆ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
      <ol id="rankingList"></ol>
      <button onclick="resetVotes()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="section">
      <h3>ğŸ™ï¸ ä»Šæ­Œã£ã¦ã„ã‚‹æ›²</h3>
      <p id="nowSinging">(æœªè¨­å®š)</p>
    </div>
    <div class="section">
      <h3>ğŸ“… æœ¬æ—¥ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3>
      <ul id="setlist"></ul>
    </div>
    <div class="section">
      <h3>ğŸµ æ›²ä¸€è¦§</h3>
      <div id="songList"></div>
    </div>
    <div class="section">
      <h3>ğŸ—¨ï¸ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´</h3>
      <div id="requestHistory"></div>
      <button onclick="clearRequests()">å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/12vltAXFRupe5x6nRPo32GMFqInpSiF8bWrV7dB0YTwE/gviz/tq?tqx=out:csv";
    let songs = [], requestLocked = false;

    function embedURL(url){
      if(!url) return "";
      let id = url.includes("youtu.be/") ? url.split("youtu.be/")[1]
        : url.includes("watch?v=") ? url.split("watch?v=")[1].split("&")[0] : "";
      return id ? `https://www.youtube.com/embed/${id}` : "";
    }

    async function load() {
      const res = await fetch(sheetURL);
      const text = await res.text();
      const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
      songs = rows.slice(1).map(r => {
        const [title, artist, genre, memo] = r.map(c => c.replace(/^"|"$/g, ''));
        return { title, artist, genre, memo, votes: 0 };
      });
      render(); updateRanking();
    }

    function render() {
      const filter = document.getElementById("search").value.toLowerCase();
      const box = document.getElementById("songList");
      box.innerHTML = "";
      songs.filter(s =>
        s.title.toLowerCase().includes(filter) ||
        s.artist.toLowerCase().includes(filter) ||
        s.genre.toLowerCase().includes(filter)
      ).forEach((s, i) => {
        const div = document.createElement("div");
        div.style.borderBottom = "1px solid #ccc";
        div.style.padding = "0.5em 0";
        div.innerHTML = `<strong>${s.title}</strong> / ${s.artist} [${s.genre}]
          <br><button onclick="vote(${i})">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
          <button onclick="setNow('${s.title}')">ä»Šæ­Œã†</button>
          <button onclick="togglePlayer(${i})">â–¶ åŸæ›²</button>
          <div id="yt${i}" style="display:none;">
            ${s.memo ? `<iframe src="${embedURL(s.memo)}" allowfullscreen></iframe>` : "ãƒªãƒ³ã‚¯ãªã—"}
          </div>`;
        box.appendChild(div);
      });
    }

    function vote(i){
      if(requestLocked) return alert("å—ä»˜åœæ­¢ä¸­ã§ã™");
      songs[i].votes++;
      updateRanking();
      const msg = document.createElement("div");
      msg.className = "bubble " + (i % 2 === 0 ? "left" : "right");
      msg.innerHTML = `<span>${songs[i].artist}</span>${songs[i].title} ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼`;
      document.getElementById("requestHistory").appendChild(msg);
    }

    function setNow(title){
      document.getElementById("nowSinging").textContent = title;
      const li = document.createElement("li");
      li.textContent = title;
      document.getElementById("setlist").appendChild(li);
    }

    function updateRanking(){
      const list = document.getElementById("rankingList");
      list.innerHTML = "";
      songs.filter(s => s.votes > 0).sort((a,b)=>b.votes-a.votes).forEach(s=>{
        const li = document.createElement("li");
        li.textContent = `${s.title}ï¼ˆ${s.artist}ï¼‰ - ${s.votes}ç¥¨`;
        list.appendChild(li);
      });
    }

    function resetVotes(){
      songs.forEach(s=>s.votes=0);
      updateRanking();
    }

    function toggleRequestLock(){
      requestLocked = !requestLocked;
      document.getElementById("lockBtn").textContent = requestLocked ? "ğŸ”’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ï¼šOFF" : "ğŸ”“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ï¼šON";
    }

    function randomRequest(){
      if(songs.length === 0) return;
      const i = Math.floor(Math.random() * songs.length);
      vote(i);
    }

    function clearRequests(){
      document.getElementById("requestHistory").innerHTML = "";
    }

    function togglePlayer(i){
      const box = document.getElementById("yt"+i);
      box.style.display = box.style.display === "block" ? "none" : "block";
    }

    load();
  </script>
</body>
</html>
