

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ITSUKI UTAーLINE</title>
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", sans-serif;
      background: #121212;
      color: #fff;
    }
    header {
      background: #00c300;
      color: white;
      padding: 1em;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
    }
    input, button {
      font-family: inherit;
      font-size: 1em;
    }
    #search {
      width: 90%;
      margin: 1em auto;
      display: block;
      padding: 0.5em;
      border-radius: 6px;
      border: none;
      background: #2a2a2a;
      color: white;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 1em;
    }
    .section {
      background: #1e1e1e;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 8px;
    }
    button {
      background: #00c300;
      color: white;
      padding: 0.4em 1em;
      border: none;
      border-radius: 6px;
      margin: 0.2em;
      cursor: pointer;
    }
    iframe {
      width: 100%;
      height: 200px;
      margin-top: 0.5em;
      border: none;
      border-radius: 8px;
    }
    /* LINE風バブル */
    .bubble {
      max-width: 70%;
      padding: 0.8em 1em;
      border-radius: 16px;
      margin: 0.4em 0;
      word-break: break-word;
    }
    .bubble.left {
      background: white;
      color: black;
      margin-right: auto;
    }
    .bubble.right {
      background: #dcf8c6;
      color: black;
      margin-left: auto;
    }
    .bubble span {
      display: block;
      font-weight: bold;
      margin-bottom: 0.3em;
      color: #333;
    }
  </style>
</head>
<body>
  <header>ITSUKI UTAーLINE</header>
  <input id="search" placeholder="曲名・アーティスト・ジャンルで検索" oninput="render()">
  <div class="container">
    <div class="section">
      <button onclick="toggleRequestLock()" id="lockBtn">🔓 リクエスト受付：ON</button>
      <button onclick="randomRequest()">🎲 ランダム</button>
    </div>
    <div class="section">
      <h3>📈 リクエストランキング</h3>
      <ol id="rankingList"></ol>
      <button onclick="resetVotes()">ランキングをリセット</button>
    </div>
    <div class="section">
      <h3>🎙️ 今歌っている曲</h3>
      <p id="nowSinging">(未設定)</p>
    </div>
    <div class="section">
      <h3>📅 本日のセットリスト</h3>
      <ul id="setlist"></ul>
    </div>
    <div class="section">
      <h3>🎵 曲一覧</h3>
      <div id="songList"></div>
    </div>
    <div class="section">
      <h3>🗨️ リクエスト履歴</h3>
      <div id="requestHistory"></div>
      <button onclick="clearRequests()">履歴をリセット</button>
    </div>
  </div>
  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/12vltAXFRupe5x6nRPo32GMFqInpSiF8bWrV7dB0YTwE/gviz/tq?tqx=out:csv";
    let songs = [], requestLocked = false;

    function embedURL(url){
      if(!url) return "";
      let id = url.includes("youtu.be/") ? url.split("youtu.be/")[1]
        : url.includes("watch?v=") ? url.split("watch?v=")[1].split("&")[0] : "";
      return id ? `https://www.youtube.com/embed/${id}` : "";
    }

    async function load() {
      const res = await fetch(sheetURL);
      const text = await res.text();
      const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
      songs = rows.slice(1).map(r => {
        const [title, artist, genre, memo] = r.map(c => c.replace(/^"|"$/g, ''));
        return { title, artist, genre, memo, votes: 0 };
      });
      render(); updateRanking();
    }

    function render() {
      const filter = document.getElementById("search").value.toLowerCase();
      const box = document.getElementById("songList");
      box.innerHTML = "";
      songs.filter(s =>
        s.title.toLowerCase().includes(filter) ||
        s.artist.toLowerCase().includes(filter) ||
        s.genre.toLowerCase().includes(filter)
      ).forEach((s, i) => {
        const div = document.createElement("div");
        div.style.borderBottom = "1px solid #333";
        div.style.padding = "0.5em 0";
        div.innerHTML = `<strong>${s.title}</strong> / ${s.artist} [${s.genre}]
          <br><button onclick="vote(${i})">リクエスト</button>
          <button onclick="setNow('${s.title}')">今歌う</button>
          <button onclick="togglePlayer(${i})">▶ 原曲</button>
          <div id="yt${i}" style="display:none;">
            ${s.memo ? `<iframe src="${embedURL(s.memo)}" allowfullscreen></iframe>` : "リンクなし"}
          </div>`;
        box.appendChild(div);
      });
    }

    function vote(i){
      if(requestLocked) return alert("受付停止中です");
      songs[i].votes++;
      updateRanking();
      const msg = document.createElement("div");
      msg.className = "bubble " + (i % 2 === 0 ? "left" : "right");
      msg.innerHTML = `<span>${songs[i].artist}</span>${songs[i].title} をリクエスト！`;
      document.getElementById("requestHistory").appendChild(msg);
    }

    function setNow(title){
      document.getElementById("nowSinging").textContent = title;
      const li = document.createElement("li");
      li.textContent = title;
      document.getElementById("setlist").appendChild(li);
    }

    function updateRanking(){
      const list = document.getElementById("rankingList");
      list.innerHTML = "";
      songs.filter(s => s.votes > 0).sort((a,b)=>b.votes-a.votes).forEach(s=>{
        const li = document.createElement("li");
        li.textContent = `${s.title}（${s.artist}） - ${s.votes}票`;
        list.appendChild(li);
      });
    }

    function resetVotes(){
      songs.forEach(s=>s.votes=0);
      updateRanking();
    }

    function toggleRequestLock(){
      requestLocked = !requestLocked;
      document.getElementById("lockBtn").textContent = requestLocked ? "🔒 リクエスト受付：OFF" : "🔓 リクエスト受付：ON";
    }

    function randomRequest(){
      if(songs.length === 0) return;
      const i = Math.floor(Math.random() * songs.length);
      vote(i);
    }

    function clearRequests(){
      document.getElementById("requestHistory").innerHTML = "";
    }

    function togglePlayer(i){
      const box = document.getElementById("yt"+i);
      box.style.display = box.style.display === "block" ? "none" : "block";
    }

    load();
  </script>
</body>
</html>
