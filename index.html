<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Itsuki Utaãƒ¼LINE - ç°¡æ˜“ç‰ˆ</title>
<style>
  body { margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:#101214; color:#e6e6e6; }
  header { background:#06C755; padding:12px; text-align:center; font-weight:700; font-size:1.2em; }
  main { display:flex; flex-direction:column; padding:10px; gap:12px; }
  input[type=text] { padding:8px; border-radius:8px; border:none; width:100%; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; border-bottom:1px solid #333; }
  th { background:#1a1a1a; cursor:pointer; position:sticky; top:0; }
  .btn { background:#06C755; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
  iframe { width:100%; height:200px; border:none; margin-top:4px; }
  @media (max-width: 768px) {
    iframe { height:160px; }
  }
</style>
</head>
<body>
<header>Itsuki Utaãƒ¼LINE - ç°¡æ˜“ç‰ˆ</header>
<main>
  <input type="text" id="search" placeholder="æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã§æ¤œç´¢" oninput="render()"/>
  <button class="btn" onclick="randomSong()">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
  <strong>ğŸ™ï¸ ä»Šæ­Œã£ã¦ã„ã‚‹æ›²:</strong> <span id="nowSinging">(æœªè¨­å®š)</span>
  <h3>ğŸ“… æœ¬æ—¥ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3>
  <ul id="setlist"></ul>
  <table>
    <thead>
      <tr>
        <th onclick="sortBy('title')">ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th onclick="sortBy('artist')">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</th>
        <th onclick="sortBy('genre')">ã‚¸ãƒ£ãƒ³ãƒ«</th>
        <th>åŸæ›²</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="songList"></tbody>
  </table>
</main>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSrwBTN0oG3_ELn7Uglv-v7MpLdhYWkRsRg_r01UIesLHPZQlAmPJPbPYcVabE9Hh44eNdnRQBzdQym/pub?gid=0&single=true&output=csv";
let songs = [];
let sortKey = "";
let sortAsc = true;

function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function escapeAttr(s) { return escapeHtml(s).replace(/"/g, "&quot;"); }

function embedURL(url) {
  if (!url) return "";
  let id = "";
  if (url.includes("youtu.be/")) id = url.split("youtu.be/")[1].split(/[?&]/)[0];
  else if (url.includes("watch?v=")) id = url.split("watch?v=")[1].split("&")[0];
  return id ? `https://www.youtube.com/embed/${id}` : "";
}

async function loadSongs() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = text.trim().split(/\r?\n/).map(r => r.split(","));
  songs = rows.slice(1).map(r => ({ title:r[0], artist:r[1], genre:r[2], memo:r[3] }));
  render();
}

function getFilteredSongs() {
  const q = document.getElementById("search").value.toLowerCase();
  let list = songs.filter(s => (s.title||"").toLowerCase().includes(q) || (s.artist||"").toLowerCase().includes(q) || (s.genre||"").toLowerCase().includes(q));
  if (sortKey) list.sort((a,b) => {
    const av = (a[sortKey]||"").toLowerCase();
    const bv = (b[sortKey]||"").toLowerCase();
    return sortAsc ? av.localeCompare(bv) : bv.localeCompare(av);
  });
  return list;
}

function render() {
  const list = getFilteredSongs();
  const tbody = document.getElementById("songList");
  tbody.innerHTML = "";
  list.forEach((s,i) => {
    const ytId = `yt-${i}`;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(s.title)}</td>
      <td>${escapeHtml(s.artist)}</td>
      <td>${escapeHtml(s.genre)}</td>
      <td>${s.memo ? `<a href="${escapeAttr(s.memo)}" target="_blank">åŸæ›²</a>` : "â€”"}</td>
      <td>
        <button class="btn" onclick="setNow('${escapeAttr(s.title)}')">ä»Š</button>
        <button class="btn" onclick="togglePlayer('${ytId}','${escapeAttr(s.memo)}')">â–¶</button>
      </td>`;
    tbody.appendChild(tr);
    const tr2 = document.createElement("tr");
    tr2.innerHTML = `<td colspan="5"><div id="${ytId}" style="display:none;"></div></td>`;
    tbody.appendChild(tr2);
  });
}

function sortBy(k) {
  if (sortKey === k) sortAsc = !sortAsc; else { sortKey = k; sortAsc = true; }
  render();
}

function setNow(title) {
  document.getElementById("nowSinging").textContent = title;
  const li = document.createElement("li");
  li.textContent = title;
  document.getElementById("setlist").appendChild(li);
}

function randomSong() {
  const list = getFilteredSongs();
  if (!list.length) return;
  const s = list[Math.floor(Math.random()*list.length)];
  setNow(s.title);
}

function togglePlayer(id, memo) {
  const box = document.getElementById(id);
  if (!box) return;
  if (box.style.display === "block") { box.style.display = "none"; box.innerHTML = ""; return; }
  const url = embedURL(memo);
  if (!url) return;
  box.style.display = "block";
  box.innerHTML = `<iframe src="${url}" allowfullscreen></iframe>`;
}

loadSongs();
</script>
</body>
</html>
