<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Itsuki Uta-Net</title>
  <style>
    /* ========== Base ========== */
    body {
      margin: 0;
      font-family: "Helvetica Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;
      background: #121212;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #1DB954;
      color: #fff;
      padding: 1em;
      text-align: center;
      font-size: 1.5em;
      font-weight: 700;
      flex-shrink: 0;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1e1e1e;
      padding: 0.6em 1em;
      position: sticky;
      top: 0;
      z-index: 10;
      gap: 0.6em;
    }
    .top-bar .controls { display: flex; flex-wrap: wrap; gap: 0.4em; align-items: center; }
    .top-bar button {
      background: #1DB954;
      color: #fff;
      border: none;
      padding: 0.5em 0.9em;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.95em;
    }
    .top-bar button:hover { filter: brightness(1.05); }

    main {
      display: flex;
      flex: 1;
      overflow: hidden; /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      gap: 0;
    }
    .left, .right {
      width: 50%;
      padding: 1em;
      box-sizing: border-box;
      overflow-y: auto; /* åˆ†å‰²ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    }

    input[type="text"] {
      width: 100%;
      padding: 0.6em;
      background: #2a2a2a;
      color: #fff;
      border: none;
      border-radius: 10px;
      margin-bottom: 0.6em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      padding: 0.6em;
      border-bottom: 1px solid #333;
      vertical-align: top;
      word-break: break-word;
    }
    th {
      background: #282828;
      cursor: pointer;         /* åˆ—ã‚¯ãƒªãƒƒã‚¯ã§ä¸¦ã³æ›¿ãˆ */
      position: sticky; top: 0; z-index: 1;
    }
    td .btns { display: flex; flex-wrap: wrap; gap: 0.3em; }
    .btns button {
      background: #1DB954;
      color: #fff;
      border: none;
      padding: 0.45em 0.7em;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
    }

    iframe {
      width: 100%;
      height: 220px;
      margin-top: 0.5em;
      border: none;
      border-radius: 8px;
    }

    /* ========== LINEé¢¨ å¹ãå‡ºã—ï¼ˆå±¥æ­´ã®ã¿ï¼‰ ========== */
    .bubble {
      max-width: 80%;
      padding: 0.8em 1em;
      border-radius: 16px;
      margin: 0.4em 0;
      word-break: break-word;
      font-size: 0.95em;
      line-height: 1.45;
      box-shadow: 0 2px 4px rgba(0,0,0,.15);
    }
    .bubble.left  { background: #fff;    color: #000; margin-right: auto; }
    .bubble.right { background: #dcf8c6; color: #000; margin-left:  auto; }
    .bubble span {
      display: block;
      font-weight: 700;
      margin-bottom: 0.25em;
      color: #333;
    }

    /* ========== Responsive (ã‚¹ãƒãƒ›æœ€é©åŒ–) ========== */
    @media (max-width: 768px) {
      header { font-size: 1.25em; }
      .top-bar { flex-direction: column; align-items: flex-start; }
      .top-bar .controls { width: 100%; }
      main { flex-direction: column; }
      .left, .right { width: 100%; max-height: 45vh; } /* ä¸Šä¸‹2æ®µã«åˆ†å‰²ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      table, th, td { font-size: 0.95em; }
      .btns button { font-size: 1rem; }
      .bubble { max-width: 95%; font-size: 1em; }
      iframe { height: 190px; }
    }
  </style>
</head>
<body>
  <header>Itsuki Uta-Net</header>

  <!-- ä¸Šéƒ¨å›ºå®šï¼šæ“ä½œãƒ‘ãƒãƒ«ï¼†ã€Œä»Šæ­Œã£ã¦ã‚‹æ›²ã€ -->
  <div class="top-bar">
    <div class="controls">
      <button onclick="toggleRequestLock()" id="lockBtn">ğŸ”“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ï¼šON</button>
      <button onclick="randomRequest()">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
    </div>
    <div><strong>ğŸ™ï¸ ä»Šæ­Œã£ã¦ã„ã‚‹æ›²:</strong> <span id="nowSinging">(æœªè¨­å®š)</span></div>
  </div>

  <main>
    <!-- å·¦ï¼šæ›²ãƒªã‚¹ãƒˆï¼ˆæ¤œç´¢ï¼‹è¡¨ï¼‹åŸæ›²åŸ‹ã‚è¾¼ã¿ï¼‰ -->
    <div class="left">
      <input id="search" type="text" placeholder="æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã§æ¤œç´¢" oninput="render()">
      <table>
        <thead>
          <tr>
            <th onclick="sortTable('title')">ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th onclick="sortTable('artist')">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</th>
            <th onclick="sortTable('genre')">ã‚¸ãƒ£ãƒ³ãƒ«</th>
            <th>åŸæ›²</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="songList"></tbody>
      </table>
    </div>

    <!-- å³ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´ -->
    <div class="right">
      <h3>ğŸ“ˆ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
      <ol id="rankingList"></ol>
      <button onclick="resetVotes()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

      <h3>ğŸ“… æœ¬æ—¥ã®ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3>
      <ul id="setlist"></ul>

      <h3>ğŸ—¨ï¸ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´</h3>
      <div id="requestHistory"></div>
      <button onclick="clearRequests()">å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </main>

  <script>
const GAS_URL = "https://script.google.com/macros/s/ttps://script.google.com/macros/s/AKfycbwx_0x7nY6i2JOjK8lxxebyPM7ZgZ53ABhdg4IQeAvCNtUDXiU_HfR7Bwlt1veGV-kv/exec";
const POLL_MS = 10000; // 10ç§’ã”ã¨ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ï¼ˆãŠå¥½ã¿ã§ï¼‰
    /* ====== è¨­å®š ====== */
    const sheetURL = "https://docs.google.com/spreadsheets/d/12vltAXFRupe5x6nRPo32GMFqInpSiF8bWrV7dB0YTwE/gviz/tq?tqx=out:csv";

    /* ====== çŠ¶æ…‹ ====== */
    let songs = [];
    let requestLocked = false;
    let sortKey = "";    // 'title' | 'artist' | 'genre'
    let sortAsc = true;  // true:æ˜‡é † / false:é™é †

    /* ====== ãƒ˜ãƒ«ãƒ‘ ====== */
    function embedURL(url){
      if(!url) return "";
      const id = url.includes("youtu.be/")
        ? url.split("youtu.be/")[1].split(/[?&]/)[0]
        : (url.includes("watch?v=") ? url.split("watch?v=")[1].split("&")[0] : "");
      return id ? `https://www.youtube.com/embed/${id}` : "";
    }

    /* ====== åˆæœŸãƒ­ãƒ¼ãƒ‰ ====== */
    async function load() {
      try {
        const res = await fetch(sheetURL, { cache: "no-store" });
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/).map(r => r.split(','));

        // 1è¡Œç›®ãƒ˜ãƒƒãƒ€ã‚’ã‚¹ã‚­ãƒƒãƒ—ã€å„åˆ—ã‚’å–ã‚Šå‡ºã—
        songs = rows.slice(1).map(r => {
          const [title, artist, genre, memo] = r.map(c => c.replace(/^"|"$/g, ''));
          return { title: title || "", artist: artist || "", genre: genre || "", memo: memo || "", votes: 0 };
        });

        render();
        updateRanking();
      } catch (e) {
        console.error("ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—:", e);
      }
    }

    /* ====== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ›²ãƒªã‚¹ãƒˆï¼‰ ====== */
    function render(){
      const filter = (document.getElementById("search").value || "").toLowerCase();
      const tbody = document.getElementById("songList");
      tbody.innerHTML = "";

      let list = songs.filter(s =>
        s.title.toLowerCase().includes(filter) ||
        s.artist.toLowerCase().includes(filter) ||
        s.genre.toLowerCase().includes(filter)
      );

      if (sortKey) {
        list.sort((a, b) => {
          const aVal = (a[sortKey] || "").toLowerCase();
          const bVal = (b[sortKey] || "").toLowerCase();
          return sortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        });
      }

      list.forEach((s, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(s.title)}</td>
          <td>${escapeHtml(s.artist)}</td>
          <td>${escapeHtml(s.genre)}</td>
          <td>${s.memo ? `<a href="${escapeAttr(s.memo)}" target="_blank" rel="noopener">åŸæ›²</a>` : "â€•"}</td>
          <td>
            <div class="btns">
              <button onclick="vote(${i})">ãƒªã‚¯</button>
              <button onclick="setNow('${escapeAttr(s.title)}')">ä»Š</button>
              <button onclick="togglePlayer(${i})">â–¶</button>
            </div>
            <div id="yt${i}" style="display:none;">${s.memo ? `<iframe src="${embedURL(s.memo)}" allowfullscreen></iframe>` : ""}</div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ====== ä¸¦ã³æ›¿ãˆ ====== */
    function sortTable(key){
      if (sortKey === key) {
        sortAsc = !sortAsc;   // åŒã˜åˆ—ãªã‚‰æ˜‡é™åè»¢
      } else {
        sortKey = key;        // åˆ¥åˆ—ãªã‚‰ãã®åˆ—ã§æ˜‡é †ã«
        sortAsc = true;
      }
      render();
    }

    /* ====== ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆç¥¨æ•°ã‚«ã‚¦ãƒ³ãƒˆï¼†å±¥æ­´ãµãã ã—ï¼‰ ====== */
    async function vote(i){
  if (requestLocked) return alert("å—ä»˜åœæ­¢ä¸­ã§ã™");

  const list = getRenderedList(); // ç¾åœ¨è¡¨ç¤ºä¸­ã®æ›²ãƒªã‚¹ãƒˆ
  const s = list[i];
  if (!s) return;

  // GASã¸é€ä¿¡ï¼ˆPOSTï¼‰
  await fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: s.title,
      artist: s.artist,
      genre: s.genre,
      ua: navigator.userAgent
    })
  }).catch(()=>{});

  // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚å¹ãå‡ºã—è¿½åŠ ï¼ˆLINEé¢¨å±¥æ­´ï¼‰
  const div = document.createElement("div");
  div.className = "bubble " + (i % 2 === 0 ? "left" : "right");
  div.innerHTML = `<span>${escapeHtml(s.artist)}</span>${escapeHtml(s.title)} ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼`;
  document.getElementById("requestHistory").appendChild(div);

  // æœ€æ–°ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
  updateRanking();
}


    // ç›´è¿‘ã® render() ã«ä½¿ã£ãŸçµã‚Šè¾¼ã¿ï¼†ä¸¦ã³æ›¿ãˆæ¸ˆã¿ãƒªã‚¹ãƒˆã‚’å–å¾—
    function getRenderedList(){
      const filter = (document.getElementById("search").value || "").toLowerCase();
      let list = songs.filter(s =>
        s.title.toLowerCase().includes(filter) ||
        s.artist.toLowerCase().includes(filter) ||
        s.genre.toLowerCase().includes(filter)
      );
      if (sortKey) {
        list.sort((a, b) => {
          const aVal = (a[sortKey] || "").toLowerCase();
          const bVal = (b[sortKey] || "").toLowerCase();
          return sortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        });
      }
      return list;
    }

    /* ====== ä»Šæ­Œã†ï¼ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ ====== */
    function setNow(title){
      document.getElementById("nowSinging").textContent = title || "(æœªè¨­å®š)";
      const li = document.createElement("li");
      li.textContent = title || "(æœªè¨­å®š)";
      document.getElementById("setlist").appendChild(li);
    }

    /* ====== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ====== */
  async function fetchSummary() {
  const res = await fetch(GAS_URL, { method: 'GET', cache: 'no-store' });
  const data = await res.json();
  return Array.isArray(data.rows) ? data.rows : [];
}

async function updateRanking() {
  const rows = await fetchSummary();
  const list = document.getElementById("rankingList");
  list.innerHTML = "";
  rows
    .sort((a,b)=> b.count - a.count)
    .forEach(row => {
      const li = document.createElement("li");
      li.textContent = `${row.title}ï¼ˆ${row.artist}ï¼‰ - ${row.count}ç¥¨`;
      list.appendChild(li);
    });
}

    function resetVotes(){
      songs.forEach(s => s.votes = 0);
      updateRanking();
    }

    /* ====== ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ãƒ­ãƒƒã‚¯ï¼ãƒ©ãƒ³ãƒ€ãƒ  ====== */
    function toggleRequestLock(){
      requestLocked = !requestLocked;
      document.getElementById("lockBtn").textContent = requestLocked
        ? "ğŸ”’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ï¼šOFF" : "ğŸ”“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ï¼šON";
    }
    function randomRequest(){
      const list = getRenderedList();
      if(list.length === 0) return;
      const i = Math.floor(Math.random() * list.length);
      // è¡¨ç¤ºä¸­ãƒªã‚¹ãƒˆã® i ç•ªç›®ã‚’ã€å…ƒé…åˆ—ã®è©²å½“æ›²ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦æŠ•ç¥¨
      const target = list[i];
      const idx = songs.findIndex(s => s.title === target.title && s.artist === target.artist && s.genre === target.genre);
      if (idx >= 0) {
        songs[idx].votes = (songs[idx].votes || 0) + 1;
        updateRanking();
        const div = document.createElement("div");
        div.className = "bubble " + (idx % 2 === 0 ? "left" : "right");
        div.innerHTML = `<span>${escapeHtml(songs[idx].artist)}</span>${escapeHtml(songs[idx].title)} ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰`;
        document.getElementById("requestHistory").appendChild(div);
      }
    }

    /* ====== å±¥æ­´ãƒªã‚»ãƒƒãƒˆ ====== */
    function clearRequests(){
      document.getElementById("requestHistory").innerHTML = "";
    }

    /* ====== YouTube åŸ‹ã‚è¾¼ã¿æŠ˜ã‚ŠãŸãŸã¿ ====== */
    function togglePlayer(i){
      // è¡¨ç¤ºä¸­ãƒªã‚¹ãƒˆã«åŸºã¥ã id ã‚’ä½¿ã†
      const box = document.getElementById("yt"+i);
      if (!box) return;
      box.style.display = (box.style.display === "block") ? "none" : "block";
    }

    /* ====== ã¡ã‚‡ã„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
    function escapeHtml(str=""){
      return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function escapeAttr(str=""){
      return escapeHtml(str).replace(/"/g, "&quot;");
    }

    /* èµ·å‹• */
 oad().then(() => {
  updateRanking();
  setInterval(updateRanking, POLL_MS);
});
  </script>
</body>
</html>
