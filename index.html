<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Itsuki Uta-Net</title>
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", sans-serif;
      background: #121212;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #1DB954;
      color: white;
      padding: 1em;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      flex-shrink: 0;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1e1e1e;
      padding: 0.5em 1em;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .left, .right {
      width: 50%;
      padding: 1em;
      box-sizing: border-box;
      overflow-y: auto;
    }
    input {
      width: 100%;
      padding: 0.5em;
      background: #2a2a2a;
      color: white;
      border: none;
      border-radius: 6px;
      margin-bottom: 0.5em;
    }
    button {
      background: #1DB954;
      color: white;
      border: none;
      padding: 0.4em 0.8em;
      border-radius: 6px;
      cursor: pointer;
      margin: 0.2em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.5em;
      border-bottom: 1px solid #333;
    }
    th {
      background: #282828;
      cursor: pointer;
    }
    iframe {
      width: 100%;
      height: 200px;
      margin-top: 0.5em;
      border: none;
    }
    .bubble {
      max-width: 80%;
      padding: 0.8em 1em;
      border-radius: 16px;
      margin: 0.4em 0;
      word-break: break-word;
      font-size: 0.95em;
    }
    .bubble.left {
      background: white;
      color: black;
      margin-right: auto;
    }
    .bubble.right {
      background: #dcf8c6;
      color: black;
      margin-left: auto;
    }
    .bubble span {
      display: block;
      font-weight: bold;
      margin-bottom: 0.3em;
      color: #333;
    }
  
@media (max-width: 768px) {
  header { font-size: 1.25em; }
  .top-bar { flex-direction: column; align-items: flex-start; gap: 0.5em; }
  main { flex-direction: column; }
  .left, .right { width: 100%; max-height: 45vh; }
  button { font-size: 1rem; padding: 0.7em 1em; }
  table, th, td { font-size: 0.95em; }
  .bubble { max-width: 95%; font-size: 1em; }
  iframe { height: 190px; }
}

</style>
</head>
<body>
  <header>Itsuki Uta-Net</header>
  <div class="top-bar">
    <div>
      <button onclick="toggleRequestLock()" id="lockBtn">🔓 リクエスト受付：ON</button>
      <button onclick="randomRequest()">🎲 ランダム</button>
    </div>
    <div>
      <strong>🎙️ 今歌っている曲:</strong> <span id="nowSinging">(未設定)</span>
    </div>
  </div>
  <main>
    <div class="left">
      <input id="search" placeholder="曲名・アーティスト・ジャンルで検索" oninput="render()">
      <table>
        <thead>
          <tr>
            <th onclick="sortTable('title')">タイトル</th>
            <th onclick="sortTable('artist')">アーティスト</th>
            <th onclick="sortTable('genre')">ジャンル</th>
            <th>原曲</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="songList"></tbody>
      </table>
    </div>
    <div class="right">
      <h3>📈 リクエストランキング</h3>
      <ol id="rankingList"></ol>
      <button onclick="resetVotes()">ランキングをリセット</button>
      <h3>📅 本日のセットリスト</h3>
      <ul id="setlist"></ul>
      <h3>🗨️ リクエスト履歴</h3>
      <div id="requestHistory"></div>
      <button onclick="clearRequests()">履歴をリセット</button>
    </div>
  </main>
  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/12vltAXFRupe5x6nRPo32GMFqInpSiF8bWrV7dB0YTwE/gviz/tq?tqx=out:csv";
    let songs = [], requestLocked = false, sortKey = "", sortAsc = true;

    function embedURL(url){
      if(!url) return "";
      let id = url.includes("youtu.be/") ? url.split("youtu.be/")[1]
        : url.includes("watch?v=") ? url.split("watch?v=")[1].split("&")[0] : "";
      return id ? `https://www.youtube.com/embed/${id}` : "";
    }

    async function load() {
      const res = await fetch(sheetURL);
      const text = await res.text();
      const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
      songs = rows.slice(1).map(r => {
        const [title, artist, genre, memo] = r.map(c => c.replace(/^"|"$/g, ''));
        return { title, artist, genre, memo, votes: 0 };
      });
      render(); updateRanking();
    }

    function render(){
      const filter = document.getElementById("search").value.toLowerCase();
      const tbody = document.getElementById("songList");
      tbody.innerHTML = "";
      let list = songs.filter(s =>
        s.title.toLowerCase().includes(filter) ||
        s.artist.toLowerCase().includes(filter) ||
        s.genre.toLowerCase().includes(filter)
      );
      if (sortKey) {
        list.sort((a, b) => {
          const aVal = a[sortKey].toLowerCase();
          const bVal = b[sortKey].toLowerCase();
          return sortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        });
      }
      list.forEach((s, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.title}</td>
          <td>${s.artist}</td>
          <td>${s.genre}</td>
          <td>${s.memo ? `<a href="${s.memo}" target="_blank">原曲</a>` : "―"}</td>
          <td>
            <button onclick="vote(${i})">リク</button>
            <button onclick="setNow('${s.title}')">今</button>
            <button onclick="togglePlayer(${i})">▶</button>
            <div id="yt${i}" style="display:none;">${s.memo ? `<iframe src="${embedURL(s.memo)}" allowfullscreen></iframe>` : ""}</div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function sortTable(key){
      sortKey = key;
      sortAsc = !sortAsc;
      render();
    }

    function vote(i){
      if(requestLocked) return alert("受付停止中です");
      songs[i].votes++;
      updateRanking();
      const div = document.createElement("div");
      div.className = "bubble " + (i % 2 === 0 ? "left" : "right");
      div.innerHTML = `<span>${songs[i].artist}</span>${songs[i].title} をリクエスト！`;
      document.getElementById("requestHistory").appendChild(div);
    }

    function setNow(title){
      document.getElementById("nowSinging").textContent = title;
      const li = document.createElement("li");
      li.textContent = title;
      document.getElementById("setlist").appendChild(li);
    }

    function updateRanking(){
      const list = document.getElementById("rankingList");
      list.innerHTML = "";
      songs.filter(s => s.votes > 0).sort((a,b)=>b.votes-a.votes).forEach(s=>{
        const li = document.createElement("li");
        li.textContent = `${s.title}（${s.artist}） - ${s.votes}票`;
        list.appendChild(li);
      });
    }

    function resetVotes(){
      songs.forEach(s=>s.votes=0);
      updateRanking();
    }

    function toggleRequestLock(){
      requestLocked = !requestLocked;
      document.getElementById("lockBtn").textContent = requestLocked ? "🔒 リクエスト受付：OFF" : "🔓 リクエスト受付：ON";
    }

    function randomRequest(){
      if(songs.length === 0) return;
      const i = Math.floor(Math.random() * songs.length);
      vote(i);
    }

    function clearRequests(){
      document.getElementById("requestHistory").innerHTML = "";
    }

    function togglePlayer(i){
      const box = document.getElementById("yt"+i);
      box.style.display = box.style.display === "block" ? "none" : "block";
    }

    load();
  </script>
</body>
</html>
